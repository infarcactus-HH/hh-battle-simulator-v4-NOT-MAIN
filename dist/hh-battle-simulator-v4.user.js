// ==UserScript==
// @name         Hentai Heroes Battle Simulator v4
// @namespace    https://github.com/rena-jp/hh-battle-simulator-v4
// @version      4.14.21
// @description  Add a battle simulator to Hentai Heroes and related games
// @author       rena
// @match        https://*.hentaiheroes.com/*
// @match        https://nutaku.haremheroes.com/*
// @match        https://*.gayharem.com/*
// @match        https://*.comixharem.com/*
// @match        https://*.hornyheroes.com/*
// @match        https://*.pornstarharem.com/*
// @match        https://*.transpornstarharem.com/*
// @match        https://*.gaypornstarharem.com/*
// @match        https://*.mangarpg.com/*
// @match        https://*.amouragent.com/*
// @grant        none
// @run-at       document-body
// @updateURL    https://github.com/rena-jp/hh-battle-simulator-v4/raw/main/dist/hh-battle-simulator-v4.meta.js
// @downloadURL  https://github.com/rena-jp/hh-battle-simulator-v4/raw/main/dist/hh-battle-simulator-v4.user.js
// ==/UserScript==

(()=>{"use strict";const e=new Promise(e=>{const t=()=>{null!=window.$&&e()};"loading"===document.readyState?window.addEventListener("DOMContentLoaded",t,!0):t()}),t=new Promise(t=>{e.then(()=>{queueMicrotask(t)})}),n=new Promise(e=>{t.then(()=>{$(e)})});function a(){return e}function s(){return t}function o(){return n}function r(e,t){const{team:n}=e,{girls:a}=n,s=Object.fromEntries(n.synergies.map(e=>[e.element.type,e.bonus_multiplier]));let o=.3*e.chance/(e.chance+t.chance);o+=s.stone;const r=["darkness","light","psychic"],l=t.team.theme;n.theme_elements.forEach(e=>{r.includes(e.type)&&l.includes(e.domination)&&(o+=.2)});const i=e=>void 0!==a[0].skills?a.map(t=>t.skills[e]?.skill.percentage_value??0).reduce((e,t)=>e+t,0)/100:10===e?0:9===e?a.map(e=>e.skill_tiers_info[4]?.skill_points_used?.2*e.skill_tiers_info[4]?.skill_points_used:0).reduce((e,t)=>e+t,0)/100:0,c=(e,t)=>{const n=e.skill_tiers_info[5];if(null==n)return 0;switch(e.girl.element_data.type){case"darkness":case"sun":if(11===t)return(1+7*n.skill_points_used)/100;break;case"light":case"stone":if(12===t)return(1+8*n.skill_points_used)/100;break;case"psychic":case"nature":if(13===t)return(1+20*n.skill_points_used)/100;break;case"water":case"fire":if(14===t)return(1+6*n.skill_points_used)/100}return 0},u=e=>c(a[0],e),m=Math.ceil(e.remaining_ego),d=u(11),p=u(12),h=u(13),f=u(14),g=c(t.team.girls[0],14);return{attack:e.damage,defense:e.defense,ego:m,baseHitChance:1-o,critHitChance:o,critMultiplier:2+s.fire,healing:s.water,attackMultiplier:1+i(9),defenseMultiplier:1+i(10),stun:d,shield:p,reflect:h,execute:f,shieldEndurance:Math.ceil(m*p),deathThreshold:m*g}}function l(e,t){return{player:r(e,t),opponent:r(t,e)}}function i(e,t){const n=["fire","nature","stone","sun","water"];let a=1;return e.theme_elements.forEach(e=>{t.theme.includes(e.domination)&&n.includes(e.domination)&&(a+=.1)}),a}function c(e,t,n=1,a){const s=i(e,t),o=s*n,l=s,c=Object.fromEntries(t.synergies.map(e=>[e.element.type,e.bonus_multiplier])).sun,u=e.caracs;return r({damage:Math.ceil(u.damage*o)*(a?.damage??1),defense:(u.defense-Math.ceil(u.defense*c))*(a?.defense??1),remaining_ego:Math.ceil(u.ego*l)*(a?.ego??1),chance:u.chance,team:e},{chance:t.caracs.chance,team:t})}const u=(()=>{const e={FastChance:function(e,n){const a=t(e,n,function(e,t){return 1},function(e,t){return 0},function(e,t,n,a){return e*t+n*a});return Math.max(0,Math.min(1,a))},FastPoints:function(e,n){const a=t(e,n,function(e,t){return Math.ceil(10*e/t)+15},function(e,t){return Math.ceil(10*(t-e)/t)+3},function(e,t,n,a){return e*t+n*a});return Math.max(3,Math.min(25,a))},Chance:function(e,n){const a=t(e,n,function(e,t){return{chance:1,alwaysWin:!0,neverWin:!1}},function(e,t){return{chance:0,alwaysWin:!1,neverWin:!0}},function(e,t,n,a){return{chance:e.chance*t+n.chance*a,alwaysWin:e.alwaysWin&&n.alwaysWin,neverWin:e.neverWin&&n.neverWin}});return a.chance=Math.max(0,Math.min(1,a.chance)),a},Points:function(e,n){const a=t(e,n,function(e,t){return s(Math.ceil(10*e/t)+15)},function(e,t){return s(Math.ceil(10*(t-e)/t)+3)},function(e,t,n,a){return{avgPoints:e.avgPoints*t+n.avgPoints*a,minPoints:Math.min(e.minPoints,n.minPoints)}});return a.avgPoints=Math.max(a.minPoints,Math.min(25,a.avgPoints)),a;function s(e){return{avgPoints:e,minPoints:e}}},Standard:function(e,n){const a=t(e,n,function(e,t){return s(1,!0,!1,Math.ceil(10*e/t)+15)},function(e,t){return s(0,!1,!0,Math.ceil(10*(t-e)/t)+3)},function(e,t,n,a){return{chance:e.chance*t+n.chance*a,alwaysWin:e.alwaysWin&&n.alwaysWin,neverWin:e.neverWin&&n.neverWin,avgPoints:e.avgPoints*t+n.avgPoints*a,minPoints:Math.min(e.minPoints,n.minPoints),maxPoints:Math.max(e.maxPoints,n.maxPoints)}});return a.chance=Math.max(0,Math.min(1,a.chance)),a.avgPoints=Math.max(a.minPoints,Math.min(a.maxPoints,a.avgPoints)),a;function s(e,t,n,a){return{chance:e,alwaysWin:t,neverWin:n,avgPoints:a,minPoints:a,maxPoints:a}}},Full:function(e,n){const a=t(e,n,function(e,t){return u(Math.ceil(10*e/t)+12)},function(e,t){return u(Math.ceil(10*(t-e)/t))},function(e,t,n,a){const s=Math.min(e.minPoints,n.minPoints),o=Math.max(e.maxPoints,n.maxPoints),r=e.pointsTable,l=n.pointsTable,i=Array(23).fill(0);for(let e=s;e<=o;e++)i[e]=r[e]*t+l[e]*a;return{minPoints:s,maxPoints:o,pointsTable:i}}),s=a.pointsTable.reduce((e,t)=>e+t),o=[0,0,0,...a.pointsTable.map(e=>e/s)],[r,l]=[[3,14],[15,26]].map(e=>o.slice(...e).reduce((e,t)=>e+t)),i=a.minPoints+3,c=a.maxPoints+3;return{chance:l/(l+r),alwaysWin:i>=15,neverWin:c<15,avgPoints:o.reduce((e,t,n)=>e+t*n,0),minPoints:i,maxPoints:c,pointsTable:o};function u(e){const t=Array(23).fill(0);return t[e]=1,{minPoints:e,maxPoints:e,pointsTable:t}}}};function t(e,t,n,a,s){const o={...e,win:n},r={...t,win:a};return l(o,e.ego,e.attack,e.defense,0,r,t.ego,t.attack,t.defense,0);function l(e,t,n,a,o,r,l,c,u,m){n*=e.attackMultiplier,u*=e.defenseMultiplier;const d=Math.max(0,Math.floor(n-u)),p=i(e,t,n,a,o,r,l,c,u,m,d),h=i(e,t,n,a,o,r,l,c,u,m,d*e.critMultiplier);return s(p,e.baseHitChance,h,e.critHitChance)}function i(e,t,n,a,o,r,i,c,u,m,d){const p=Math.ceil(d);let h=0;if(r.shield&&1<=m&&m<=r.shieldEndurance){const e=r.shieldEndurance-(m-1);h=Math.min(p,e),m+=h}const f=p-h;if(i-=Math.ceil(f),t+=Math.ceil(f*e.healing),t=Math.min(t,e.ego),i<=0)return e.win(t,e.ego);if(r.reflect&&1<=m&&m<=2&&(!e.stun||1!=o)){m++;const n=Math.ceil(f*r.reflect);let a=0;if(e.shield&&1<=o&&o<=e.shieldEndurance){const t=e.shieldEndurance-(o-1);a=Math.min(n,t),o+=a}t-=n-a}if(e.execute&&i<=r.deathThreshold)return e.win(t,e.ego);if(e.stun&&1===o)return l(e,t,n,a,++o,r,i,c,u,m);e.reflect&&0===o&&(o=1),e.shield&&0===o&&(o=1);const g=l(r,i,c,u,m,e,t,n,a,o);if(e.stun&&0===o){const d=l(e,t,n,a,o=1,r,i,c,u,m);return s(d,e.stun,g,1-e.stun)}return g}}self.addEventListener("message",t=>{const{id:n,type:a,args:s}=t.data;try{const t=(0,e[a])(s[0],s[1]);self.postMessage({id:n,ret:t})}catch(e){self.postMessage({id:n,error:e})}})}).toString().match(/{.+}/s)[0],m=new Blob([u],{type:"text/javascript"}),d=URL.createObjectURL(m),p=navigator?.hardwareConcurrency??1,h=[],f=new Map;let g=0,b=0;async function y(e,t,n){return await async function(e,t){const n=b++,a={id:n,type:e,args:t};return function(){let e=h[g];if(null==e){e=new Worker(d);const t=({data:e})=>{const{id:t,ret:n,error:a}=e;null!=n?f.get(t).resolve(n):f.get(t).reject(a),f.delete(t)},n=e=>{throw e};e.addEventListener("message",t),e.addEventListener("messageerror",n),e.addEventListener("error",n),h[g]=e}return g=(g+1)%p,e}().postMessage(a),new Promise((e,t)=>{f.set(n,{resolve:e,reject:t})})}(e,[t,n])}async function _(e,t,n){const a=r(t,n),s=r(n,t);return await y(e,a,s)}async function w(e,t,n,a=1,s){const o=c(t,n,a,s),r=c(n,t);return await y(e,o,r)}function v(e,t=0){return(Math.floor(Math.round(e*10**(t+1))/10)/10**t).toLocaleString()}function k(e,t=0){return(Math.round(e*10**t)/10**t).toLocaleString()}function S(e){const t=100*e;return t>=100?"100%":t>=10?`${v(t,1)}%`:t>=.01?`${v(t,2)}%`:t>=0?`${v(t,3)}%`:"0%"}function M(e){const t=100*e;return t>=100?"100%":t>=.01?`${v(t,2)}%`:t>=0?`${v(t,3)}%`:"0%"}function E(e){return e>=25?"25":v(e,e>24.9?3:2)}function T(e,t){return e>=2?`<td colspan="${e}">${t}</td>`:`<td>${t}</td>`}function C(e,t){return t.map(t=>T(e,t)).join("")}function P(...e){return["<tr>",...e,"</tr>"].join("")}function x(e,t){const n=(e,t)=>{let n=e.attack,a=t.defense;const s=[];for(let t=0;t<10;t++){const t=Math.max(0,Math.floor(n-a)),o=[];o.push(t),o.push(Math.ceil(t*e.healing)),o.push(Math.ceil(t*e.critMultiplier)),o.push(Math.ceil(t*e.critMultiplier*e.healing)),s.push(o),n*=e.attackMultiplier,a*=e.defenseMultiplier}return s},a=n(e,t),s=n(t,e),o=[e,t].flatMap(e=>[e.baseHitChance,e.critHitChance]);return $('<table class="sim-table"></table>').append(P(T(1,""),C(4,["Player","Opponent"]))).append(P(T(1,""),C(2,["Normal","Critical"]).repeat(2))).append(P(T(1,"%"),C(2,o.map(e=>S(e))))).append(P(T(1,""),C(1,["Damage","Healing"]).repeat(4))).append([...Array(9)].map((e,t)=>t+1).map(e=>P(T(1,e),...[a,s].map(t=>C(1,t[e].map(e=>e.toLocaleString()))))).join("")).prop("outerHTML")}function L(e,t,n){return e<=t?t:e>=n?n:e}function j(e){return Math.round(255*Math.sqrt(L(e,0,1)))}function A(e){return`rgb(${j(2-2*e)}, ${j(2*e)}, 0)`}function H(e){return A(L(e,0,1)**3)}function B(e){return A(((L(e,3,25)-3)/22)**3)}window.HHBattleSimulator={simulateFromFighters:async(e,t)=>await _("Standard",e,t),simulateFromFightersEx:async(e,t,n)=>await _(e,t,n),simulateFromTeams:async(e,t,n=1)=>await w("Standard",e,t,n),simulateFromTeamsEx:async(e,t,n,a=1)=>await w(e,t,n,a)};class I{element;last;constructor(){this.element=$('<div class="sim-result"></div>')}updateAsync(e){return this.reset(),this.last=e,queueMicrotask(async()=>{const t=await e;if(this.last!==e)return;const n=t.hasAssumptions?"?":"";let a="";t.alwaysWin&&(a='<div class="vCheck_mix_icn sim-mark"></div>'),t.neverWin&&(a='<div class="xUncheck_mix_icn sim-mark"></div>'),this.element.removeClass("sim-pending").html(`<div class="sim-label">P[W]:</div>${a}<span class="sim-chance">${S(t.chance)}${n}</span>`).css("color",H(t.chance))}),this.element}reset(){this.element.addClass("sim-pending").html('<div class="sim-label">P[W]:</div>-').css("color","")}setTooltip(e){this.element.attr("tooltip",e)}getElement(){return this.element}}const O=(async()=>(null!=window.HHPlusPlus||(await a(),null!=window.HHPlusPlus||(await o(),null!=window.HHPlusPlus||await new Promise($))),window.HHPlusPlus))(),G=(async()=>(null!=window.hhPlusPlusConfig||(await a(),null!=window.hhPlusPlusConfig||(await o(),null!=window.hhPlusPlusConfig||await new Promise($))),window.hhPlusPlusConfig))();function F(){return O}const q={addBattleSimulator:!0,doSimulateTroll:!0,doSimulateLeague:!0,doSimulateSeason:!0,doSimulatePantheon:!0,doSimulateTeams:!0,doSimulateEditTeam:!0,doSimulateLeagueTable:!0,doSimulateFoughtOpponents:!0,addChanceToLeagueTable:!1,addGuaranteedMarkToLeagueTable:!0,addBoosterSimulatorToLeagueTable:!0,replaceHHLeaguesPlusPlus:!0,addBoosterSimulator:!0,simulateGinseng:!0,simulateJujubes:!0,simulateChlorella:!0,simulateCordyceps:!0,addSkillSimulator:!0,skillLevelsToBeSimulated:[5,4,3,2,1],calculateLeaguePointsTable:!1,addGirlTraitsToGirlTooltip:!0};function N(){return q}function R(e,t){return null!=e?+e:t}function W(e,t,n){return Array.isArray(t)?e.reduce((e,a,s)=>(e[a]=R(t[s],n),e),{}):e.reduce((e,a)=>(e[a]=R(t[a],n),e),{})}function U(e,t,n,a){return"number"==typeof n?e.reduce((e,s)=>(e[s]=a(t[s],n),e),{}):e.reduce((e,s)=>(e[s]=a(t[s],n[s]),e),{})}function z(e,t,n){return U(e,t,n,(e,t)=>e+t)}function J(e,t,n){return U(e,t,n,(e,t)=>e*t)}function D(e,t){return e.reduce((e,n)=>(e[n]=Math.floor(t[n]),e),{})}class K{keys;value;constructor(e,t={}){this.keys=e,this.value=W(e,t,0)}add(e){return this.value=z(this.keys,this.value,e),this}subtract(e){return this.value=U(this.keys,this.value,e,(e,t)=>e-t),this}multiply(e){return this.value=J(this.keys,this.value,e),this}divide(e){return this.value=U(this.keys,this.value,e,(e,t)=>e/t),this}truncate(){return this.value=D(this.keys,this.value),this}round(){var e,t;return this.value=(e=this.keys,t=this.value,e.reduce((e,n)=>(e[n]=Math.round(t[n]),e),{})),this}result(){return this.value}}const V=["damage","defense","ego","chance"];class Q extends K{constructor(e={}){super(V,e)}}function X(e){return W(V,e,0)}function Y(e,t){return z(V,e,t)}const Z={MB2:{leagues:1.15,seasons:1.15},MB3:{trolls:1.25,pantheon:1.25},MB8:{leagues:1.15,seasons:1},MB9:{leagues:1,seasons:1.15}};function ee(e){const t=[];let n={};return e.forEach(e=>{const{item:a}=e;switch(a.rarity){case"common":case"rare":case"epic":t.push({addend:X(a),lifetime:+e.lifetime});break;case"legendary":t.push({multiplier:X(a),lifetime:+e.lifetime});break;case"mythic":const s=Z[a.identifier];null!=s&&(n={...n,...s})}}),{normals:t,mythic:n}}const te=["hardcore_stats","charm_stats","know_how_stats","endurance_stats","harmony_stats"],ne=["carac1","carac2","carac3","endurance","chance"];function ae(e){return W(ne,e,0)}function se(e,t){return z(ne,e,t)}function oe(e,t){return J(ne,e,t)}function re(e){return e.Hero??e.shared?.Hero}class le{element;last;constructor(){this.element=$('<div class="sim-result"></div>')}updateAsync(e){return this.reset(),this.last=e,queueMicrotask(async()=>{const t=await e;if(this.last!==e)return;const n=t.hasAssumptions?"?":"";let a="";t.minPoints>=25&&(a='<div class="vCheck_mix_icn sim-mark"></div>'),this.element.removeClass("sim-pending").html(`<div class="sim-label">E[P]:</div>${a}<span class="sim-points">${E(t.avgPoints)}${n}</span>`).css("color",B(t.avgPoints))}),this.element}reset(){this.element.addClass("sim-pending").html('<div class="sim-label">E[P]:</div>-').css("color","")}setTooltip(e){this.element.attr("tooltip",e)}getElement(){return this.element}}function ie(e,t){const n=localStorage.getItem(e);if(null==n)return t;try{const e=JSON.parse(n);if(null!=e){if(Array.isArray(e))return e;if(null!=t&&"object"==typeof e&&"object"==typeof t)return{...t,...e}}return e}catch(e){return n}}function ce(e,t){localStorage.setItem(e,JSON.stringify(t))}function ue(e){ce("HHBattleSimulator.HeroData",{classBonus:e.classBonus,ginsengCaracs:e.ginsengCaracs})}function me(){return ie("HHBattleSimulator.HeroData",{})}function de(){const e=me().ginsengCaracs;return 1===e?.version?e.data:null}function pe(e){ce("HHBattleSimulator.TeamData",{opponent:e.opponent,league:e.league,params:e.params})}function he(){return ie("HHBattleSimulator.TeamData",{})}function fe(e){const t=he();t.opponent=e,pe(t)}function ge(){return he().opponent??null}function be(e){const t=he();t.league=e??void 0,pe(t)}function ye(){return he().league??null}function _e(...e){const{pathname:t}=window.location;return e.some(e=>t.includes(e))}function we(){const e=window.location.search.match(/id_opponent=(\d+)/)?.[1];if(null==e)throw new Error("id_opponent is not found from url.");return e}function ve(e){return(window.shared?.general??window).getDocumentHref(e)??e}function ke(e){ce("HHBattleSimulator.BoosterData",{normals:e.normals,mythic:e.mythic})}function $e(){return ie("HHBattleSimulator.BoosterData",{})}function Se(e){const t=$e();t.mythic=e,ke(t)}function Me(){return $e().mythic??{}}function Ee(e){const{$:t}=e;if(null==t)throw new Error("jQuery is not found.");const{localStorageGetItem:n,localStorageSetItem:a,get_lang:s,get_dec_and_sep:o}=e;if(null==n)throw new Error("localStorageGetItem is not found.");if(null==a)throw new Error("localStorageSetItem is not found.");if(null==s)throw new Error("get_lang is not found.");if(null==o)throw new Error("get_dec_and_sep is not found.");const{SITE_ROOT:r,IMAGES_URL:l}=e;if(null==r)throw new Error("SITE_ROOT is not found.");if(null==l)throw new Error("IMAGES_URL is not found.");if(null==(e.Hero??e.shared?.Hero))throw new Error("Hero is not found.")}async function Te(e){await s();try{Ee(e),N().addGirlTraitsToGirlTooltip&&async function(e){let t=null;$("body").on("mouseenter touchstart","[data-new-girl-tooltip]",e=>{t=e.currentTarget});const n=e.$;if("function"!=typeof n)return;e.$=new Proxy(n,{apply(n,o,r){const l=n.apply(o,r);return"#overlay"!==r?.[0]?l:new Proxy(l,{get(n,o){const r=n[o];return"after"!==o?r:new Proxy(r,{apply(n,o,r){const l=r[0],i=l?.is?.(".hh_tooltip_new.new_girl_tooltip");if(i){const n=l;(function(n){if(null==t)return;const o=s($(t));if(null!=o){const t=a.get(+o);if(null!=t){const a={"♈":"aries","♉":"taurus","♊":"gemini","♋":"cancer","♌":"leo","♍":"virgo","♎":"libra","♏":"scorpio","♐":"sagittarius","♑":"capricorn","♒":"aquarius","♓":"pisces"},s=e.IMAGES_URL+"/pictures/design/blessings_icons/",o=e=>`<span class="sim-trait-icon" style="background-image: url('${s}${e}');"></span>`,r=e=>""==e?"":o(`hair_colors/hair_color_${e}.png`),l=e=>""==e?"":o(`eye_colors/eye_color_${e}.png`),i=e=>""==e?"":o(`zodiac_signs/zodiac_sign_${a[e.charAt(0)]}.png`),c=e=>""==e?"":o(`positions/fav_pose_${e}.png`),u=['<div class="sim-traits">',r(t[0]),r(t[1])," ",l(t[2]),l(t[3])," ",i(t[4])," ",c(t[5]),"</div>"];n.append(u.join(""))}}const r=n.find(".active_skills_icn");if(r.length>0){const t=n.find(".element_tooltip_icn").attr("class").match(/(\w+?)_element_icn/)[1];if(null!=t){const a="/pvp4_trigger_skills/stun_icon.png",s="/pvp4_trigger_skills/shield_icon.png",o="/pvp3_active_skills/reflect_icon.png",l="/pvp3_active_skills/execute_icon.png",i={darkness:a,sun:a,stone:s,light:s,nature:o,psychic:o,fire:l,water:l},c={darkness:"/pvp4_trigger_skills/punch_icon.png",sun:"/pvp4_trigger_skills/stun_icon.png",stone:"/pvp4_trigger_skills/defenses_up_icon.png",light:"/pvp4_trigger_skills/heal_up_icon.png",nature:"/pvp4_trigger_skills/mana_boost_icon.png",psychic:"/pvp4_trigger_skills/mana_steal_icon.png",fire:"/pvp4_trigger_skills/burn_icon.png",water:"/pvp4_trigger_skills/shield_icon.png"},u=(n.find('[carac="carac-speed"]').length>0?c:i)[t];if(null!=u){const t=r.css("background-image").replace("/images/pictures/design/girl_skills/active_skills_icon.png",e.IMAGES_URL+"/pictures/design/girl_skills"+u);r.css("background-image",t)}}}})(n),function(n){if(null==t)return;const a=$(t),o=s(a);if(null==o)return;if(!(n.find('[carac="carac-speed"]').length>0))return;const{hero_fighter:r,opponent_fighter:l}=e,i=a.closest(".player-panel").length>0,c=a.closest(".opponent-panel").length>0,u=i?r:c?l:null;if(null==u)return;const m=Object.values(u.fighters).find(e=>+e.id_girl===+o);if(null==m)return;const d=e.number_format,p=(e,t,a)=>{a>t&&n.find(`[carac="${e}"]`).addClass("sim-with-relics").text(d(a))},h=m.girl.battle_caracs;p("ego",h.ego,m.initial_ego),p("chance",h.chance,m.chance),p("damage",h.damage,m.damage),p("def0",h.defense,m.defense),p("carac-speed",h.speed,m.speed)}(n)}return n.apply(o,r)}})}})}});const a=new Map;function s(e){let t=e.closest("[data-girl-id]").attr("data-girl-id");if(null==t&&(t=JSON.parse(e.attr("data-new-girl-tooltip")??"").id_girl),null==t){const n=e.is("[girl-ico-src]")?e:e.find("[girl-ico-src]");t=n.attr("girl-ico-src")?.match(/pictures\/girls\/(\d+)\/(?:ico|ava|grade_skins\/ico)/)?.[1],t??=n.attr("src")?.match(/pictures\/gallery\/\d+\/\d+x\/(\d+)-.+\.png/)?.[1]}if(null==t){const n=e.is("img[src]")?e:e.find("img[src]");t=n.attr("src")?.match(/pictures\/girls\/(\d+)\/(?:ico|ava|grade_skins\/ico)/)?.[1],t??=n.attr("src")?.match(/pictures\/gallery\/\d+\/\d+x\/(\d+)-.+\.png/)?.[1]}return t}const o=e=>{if(null==e?.id_girl)return;const t=[e.hair_color1??e.girl?.hair_color1??"",e.hair_color2??e.girl?.hair_color2??"",e.eye_color1??e.girl?.eye_color1??"",e.eye_color2??e.girl?.eye_color2??"",e.zodiac??e.girl?.zodiac??"",e.figure??e.girl?.figure??""];t.every(e=>""===e)||a.set(+e.id_girl,t)};if(_e("/troll-pre-battle.html","/leagues-pre-battle.html","/pantheon-pre-battle.html")&&(e.hero_data.team.girls.map(e=>o(e)),e.opponent_fighter.player.team.girls.map(e=>o(e))),_e("/troll-battle.html","/league-battle.html","/pantheon-battle.html","/season-battle.html","/boss-bang-battle.html")&&(e.hero_fighter.girls.map(e=>o(e)),e.opponent_fighter.girls.map(e=>o(e))),_e("/leagues.html")&&e.opponents_list.forEach(e=>e.player.team.girls.map(e=>o(e))),_e("/season-arena.html")&&(e.hero_data.team.girls.map(e=>o(e)),e.opponents.forEach(e=>e.player.team.girls.map(e=>o(e)))),_e("/teams.html")){const t=e.teams_data;Object.values(t).forEach(e=>{e.girls.map(e=>o(e))})}if(_e("/edit-team.html")&&e.availableGirls.forEach(e=>o(e)),_e("/waifu.html")&&e.girls_data_list.forEach(e=>o(e)),_e("/path-of-valor.html","/path-of-glory.html")&&e.path_girls.forEach(e=>o(e)),_e("/activities.html")){const t=e.pop_hero_girls;null!=t&&Object.values(t).forEach(e=>o(e))}if(_e("/pantheon.html")&&Array.isArray(girl_rewards)&&girl_rewards.forEach(e=>o(e.girl_data)),_e("/clubs.html")){const t=e.club_champion_data,n=t?.champion?.girl;null!=n&&o(n)}if(_e("/champions/")){const t=e.championData,n=t?.champion?.girl;null!=n&&o(n)}if(_e("/girl/")){const t=e.girl;null!=t&&o(t),$(document).on("ajaxComplete",(e,t,n)=>{if(n.data?.includes("action=get_teams_for_girl")){const e=t.responseJSON;e?.teams?.forEach(e=>e.girls.forEach(e=>o(e)))}})}if(_e("/event.html")){const t=e.event_girls;t?.forEach(e=>o(e));const n=e.current_event;n?.event_data?.indexed_hero_teams?.forEach(e=>{e.girls?.forEach(e=>o(e))})}if(_e("/add-boss-bang-team.html")&&e.availableGirls.forEach(e=>o(e)),_e("/labyrinth.html")&&$(document).on("ajaxComplete",(e,t,n)=>{if(n.data?.includes("action=event_market_get_data&feature=labyrinth")){const e=t.responseJSON;o(e?.additional_information)}}),_e("/labyrinth-pre-battle.html")){const t=e.hero_fighter;Object.values(t.team.girls).map(e=>o(e)),e.opponent_fighter.team.girls.map(e=>o(e))}}(e)}catch(e){}}function Ce(e){const{localStorageGetItem:t}=e,n=t("battle_type"),a=ge();if(null==a||a.battleType!==n)return null;const s={leagues:()=>t("leagues_id"),trolls:()=>t("troll_id"),pantheon:()=>t("pantheon_id"),seasons:()=>a.opponentId},o=s[n]?.();return o===a.opponentId?a.team:null}function Pe(e){return $e().mythic?.[e]??null}function xe(e){if("pointsTable"in e){const t=Math.sqrt(e.pointsTable.reduce((e,t)=>Math.max(e,t),0)),n=e.pointsTable.map((e,t)=>({points:t,probability:e})).filter(e=>e.probability>0).sort((e,t)=>t.points-e.points).flatMap(e=>[`<tr style="color: ${B(e.points)};">`,"<td>",e.points.toFixed(),"</td>",'<td class="sim-bar-container">',`<div class="sim-bar" style="width: ${5*e.probability/t}rem;"></div>`,M(e.probability),"</td>","</tr>"]);return $('<table class="sim-points-table"></table>').append(n.join("")).prop("outerHTML")}return $('<table class="sim-table"></table>').append(P(T(2,"Points"))).append(P(C(1,["Max",e.maxPoints.toFixed()]))).append(P(C(1,["Avg",(t=e.avgPoints,t>=25?"25":t>24.9?(25-parseFloat((25-t).toPrecision(2))).toLocaleString():v(t,2))]))).append(P(C(1,["Min",e.minPoints.toFixed()]))).prop("outerHTML");var t}class Le{mojo;currentMojo;element;last;constructor(e,t){this.mojo=e,this.currentMojo=t,this.element=$('<div class="sim-result"></div>')}updateAsync(e){return this.reset(),this.last=e,queueMicrotask(async()=>{const t=await e;if(this.last!==e)return;const n=t.hasAssumptions?"?":"",a=t.chance,s=1-a,o=this.mojo;let r=Math.min(o-40,-1);this.currentMojo<7300&&(r=Math.max(r,-10));const l=o*a+r*s;this.element.removeClass("sim-pending").html(`<div class="sim-label">E[M]:</div><span class="sim-mojo">${k(l,2)}${n}</span>`).css("color",function(e){let t=L(e+10,0,40)/40;return t=.5-.5*Math.cos(t**2*Math.PI),A(t)}(l)).attr("tooltip",$('<table class="sim-table"></table>').append(P(T(1,""),C(1,["Win","Loss"]))).append(P(T(1,"Mojo"),C(1,[o,r].map(e=>k(e,2))))).append(P(T(1,"%"),C(1,[a,s].map(e=>S(e))))).append(P(T(1,"E[M]"),T(2,k(l,2)))).prop("outerHTML"))}),this.element}reset(){this.element.addClass("sim-pending").html('<div class="sim-label">E[M]:</div>-').css("color","")}getElement(){return this.element}}async function je(e){if(!_e("/edit-team.html"))return;await s(),function(e){Ee(e);const{hero_data:t,teamGirls:n,theme_resonance_bonuses:a,availableGirls:s}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("teamGirls is not found.");if(null==a)throw new Error("theme_resonance_bonuses is not found.");if(null==s)throw new Error("availableGirls is not found.")}(e);const t=N(),{availableGirls:n}=e,a=Object.fromEntries(n.map(e=>[e.id_girl,e])),{get_lang:r,get_dec_and_sep:l}=e,i=l(r()).sep,u=e=>parseFloat(e.trim().replaceAll(i,"")),m=()=>{const e=e=>u($(`#stats-${e}`).text());return{damage:e("damage"),defense:e("defense"),ego:e("ego"),chance:e("chance")}},d=()=>{const e=Array(7);return document.querySelectorAll(".team-hexagon [data-girl-id]").forEach(t=>{const n=t.dataset.teamMemberPosition,s=t.dataset.girlId;null!=n&&null!=s&&(e[+n]=a[s])}),e.filter(e=>null!=e)},p=()=>({caracs:m(),total_power:u($(".team-total-power").text()),girls:d(),id_team:e.hero_data.team.id_team});!async function(e){const{hero_data:t,server_now_ts:n}=e,s=re(e),r=t.team;Ge({...r,girls:r.girls.map(e=>a[e.id_girl])},s,n),await o();const l=document.getElementById("validate-team");null!=l&&l.addEventListener("click",()=>{Ge(p(),s,n)},!0)}(e),t.doSimulateEditTeam&&async function(e){const{hero_data:n,teamGirls:a,theme_resonance_bonuses:s,availableGirls:r,localStorageGetItem:l}=e,i=Ce(e);if(null==i)return;const u=i,d=n.team;if(null==d)return;const h=new Map(Object.values(r).map(e=>[String(e.id_girl),e])),f=l("battle_type"),g=Pe(f);if(null==g)return;const b=Object.fromEntries(d.synergies.map(e=>[e.element.type,e.element]));let _={...d},w=!1;await o();const v=$(".player_team_block.battle_hero .icon-area"),k=new I;v.before(k.getElement().addClass("sim-left"));const S="leagues"===f?new le:null;null!=S&&v.before(S.getElement().addClass("sim-right"));const M=ge()?.mojo,E=ge()?.currentMojo,T="seasons"===f&&null!=M&&null!=E?new Le(M,E):null;null!=T&&v.before(T.getElement().addClass("sim-right")),L();const C=document.querySelector(".player_stats");null!=C&&new MutationObserver(function(){const e=m(),t=Array.from(document.querySelectorAll(".team-member-container[data-girl-id]")).sort((e,t)=>Number(e.dataset.teamMemberPosition)-Number(t.dataset.teamMemberPosition)).map(e=>h.get(e.dataset.girlId));w=!1,_.girls=t.map(e=>{const t=e.id_girl,n=a.find(e=>e.id_girl==t);if(null!=n)return{...e,skills:n.skills,girl:{element_data:e.element_data}};const s={},o=e.skill_tiers_info[4]?.skill_points_used??0;o&&(w=!0,s[9]={skill:{percentage_value:.2*o}},s[10]={skill:{percentage_value:0}});const r=e.skill_tiers_info[5]?.skill_points_used??0;if(r>0){const t=e.element;["darkness","sun"].includes(t)&&(s[11]={skill:{percentage_value:7*r}}),["stone","light"].includes(t)&&(s[12]={skill:{percentage_value:8*r}}),["nature","psychic"].includes(t)&&(s[13]={skill:{percentage_value:20*r}}),["fire","water"].includes(t)&&(s[14]={skill:{percentage_value:6*r}})}return{...e,skills:s,girl:{element_data:e.element_data}}});const n=Object.fromEntries(Object.keys(b).map(e=>[e,0]));t.forEach(e=>{n[e.element]++}),_.synergies=d.synergies.map(e=>({...e,element:{type:e.element.type},bonus_multiplier:e.harem_bonus_multiplier+e.team_bonus_per_girl*n[e.element.type]}));const o=Object.entries(n).filter(([e,t])=>t>=3).map(([e,t])=>e);if(_.theme_elements=o.map(e=>b[e]),_.theme=o.join(","),o.length>0){const t=s[""];if(t){const{defense:n,chance:a}=t;n&&(e.defense/=Math.pow(1.02,n/2)),a&&(e.chance/=Math.pow(1.04,a/4))}o.forEach(t=>{const n=s[t];if(n){const{defense:t,chance:a}=n;t&&(e.defense*=Math.pow(1.02,t/2)),a&&(e.chance*=Math.pow(1.04,a/4))}})}_.caracs=e,L()}).observe(C,{subtree:!0,childList:!0});const P=document.querySelector(".team-hexagon");function L(){const e=w,n=c(_,u,g??1),a=c(u,_),s=y(null==S?"Chance":t.calculateLeaguePointsTable?"Full":"Standard",n,a).then(t=>({...t,hasAssumptions:e}));if(k.updateAsync(s),k.setTooltip(x(n,a)),null!=S){const e=s;S.updateAsync(e),e.then(e=>{S.setTooltip(xe(e))})}null!=T&&T.updateAsync(s)}null!=P&&new MutationObserver(function(){const e=_.girls,t=+e[0]?.id_girl,n=new Set(e.map(e=>+e.id_girl)),a=p().girls.map(e=>+e.id_girl),s=a[0];if(a.length==e.length&&a.every(e=>n.has(e)))return s===t?void 0:(_.girls=a.map(t=>e.find(e=>+e.id_girl===+t)),void L());k.reset(),S?.reset(),T?.reset()}).observe(P,{subtree:!0,attributes:!0,attributeFilter:["src"]})}(e)}let Ae,He=null;async function Be(e,t){return He??=(async()=>{t??=window.battle_type??localStorage.battle_type;const n=ve(`edit-team.html?battle_type=${t}&id_team=${e}`),a=await fetch(n),s=await a.text();return{teamGirls:JSON.parse(s.match(/var\s+teamGirls\s*=\s*(\[.*?\]);/)[1]),theme_resonance_bonuses:JSON.parse(s.match(/var\s+theme_resonance_bonuses\s*=\s*((?:\{|\[).*?(?:\}|\]));/)[1]),hero_data:Function("return "+s.match(/var\s+hero_data\s*=\s*(\{.*?\});/s)[1])(),availableGirls:JSON.parse(s.match(/var\s+availableGirls\s*=\s*(\[.*?\]);/)[1]),Hero_infos:JSON.parse(s.match(/Hero.infos\s*=\s*(\{.*?\});/)[1])}})(),He}async function Ie(e,t,n){if(null!=Ae)return Ae;const a=await Be(e),s=Object.fromEntries(a.availableGirls.map(e=>[e.id_girl,e])),o={...a.hero_data.team,girls:a.hero_data.team.girls.map(e=>s[e.id_girl])},r={...t,infos:a.Hero_infos};return Ae=Ge(o,r,n),Ae}let Oe=null;function Ge(e,t,n){const a=me().classBonus??null;if(null==a)return;const s=function(e){const{normals:t}=$e();if(null==t)return null;const n=new Q,a=new Q;return t.forEach(t=>{t.lifetime<e||(null!=t.multiplier&&n.add(t.multiplier),null!=t.addend&&a.add(t.addend))}),{multiplier:n.divide(100).add(1).result(),addend:a.result()}}(n);if(null==s)return;const o=e.girls.flatMap(e=>e.armor.map(e=>X(e.caracs))).reduce((e,t)=>Y(e,t),X({})),r={damage:.25*(l=e.total_power),defense:.12*l,ego:2*l,chance:0};var l;const i=(new Q).add(r).add(function(e){const{caracs:t}=e.infos;return{damage:t.primary_carac_amount,defense:.25*t.secondary_caracs_sum,ego:t.endurance,chance:t.chance}}(t)).add(s.addend).multiply(s.multiplier).multiply(a).add(o).result(),c=r,u=a,m=o,d=(new Q).add(e.caracs).divide(i).result(),p={teamId:+e.id_team,addend1:c,multiplier1:u,addend2:m,multiplier2:d,caracs:e.caracs};return function(e){const t=he();t.params??=[],t.params=[{...e,version:2},...t.params.filter(e=>2===e.version).filter(t=>t.teamId!==e.teamId)],pe(t)}(p),p}function Fe(e,t){const n=i(e.team,t.team);return Math.round(100*e.damage/e.team.caracs.damage/n)/100}async function qe(e){if(null==e.id_team)return;const t=e.id_team,n=(he().params??[]).filter(e=>2===e.version).find(e=>e.teamId===+t);if(null!=n?.caracs&&(a=n.caracs,s=e.caracs,function(e,t,n){return e.every(e=>+t[e]===+n[e])}(V,a,s)))return n;var a,s;const o=re(window);return null!=o?await Ie(+t,o,window.server_now_ts):void 0}const Ne=["ginseng","jujubes","chlorella","cordyceps","mythic"];function Re(e,t,n,a){const{ginseng:s,jujubes:o,chlorella:r,cordyceps:l}=a,i=n[s];return{...e,caracs:new Q(i).add(t.addend1).multiply(t.multiplier1).multiply((c={damage:1+.1*l,ego:1+.1*r,chance:1+.2*o},W(V,c,1))).add(t.addend2).multiply(t.multiplier2).round().result()};var c}function We(e,t){const n={...e.girls[0].skills};[11,12,13,14].forEach(e=>{delete n[e]}),n[t.skill.id_skill]=t;const a=[...e.girls];return a[0]={...e.girls[0],skills:n},{...e,girls:a}}let Ue=null;function ze(){if(null==Ue){const{simulateGinseng:e,simulateJujubes:t,simulateChlorella:n,simulateCordyceps:a}=N();Ue=[...Array(2)].flatMap((s,o)=>[...Array(a?5:1)].flatMap((a,s)=>[...Array(n?5-s:1)].flatMap((n,a)=>[...Array(t?5-s-a:1)].flatMap((t,n)=>{const r=4-s-a-n;return!e&&r>0?[]:{key:`${r}${n}${a}${s}${o}`,counts:{ginseng:r,jujubes:n,chlorella:a,cordyceps:s,mythic:o}}}))))}return Ue}async function Je(e){const t=ze();return Promise.all(t.map(async({counts:t})=>({boosterCounts:t,result:await e(t)})))}async function De(e,t){const n=de();if(null==n)throw new Error("Market data not found");const a=await qe(e);if(null==a)throw new Error("Team data not found");return Je(async s=>{const o=Re(e,a,n,s),r=1+.15*s.mythic;return w("FastPoints",o,t,r)})}async function Ke(e){const t={11:{skillType:"stun",levelPercentage:7},12:{skillType:"shield",levelPercentage:8},13:{skillType:"reflect",levelPercentage:20},14:{skillType:"execute",levelPercentage:6}},n=N().skillLevelsToBeSimulated;return 0===n.length?[]:Promise.all([11,12,13,14].map(async a=>{const s=await Promise.all(n.map(async n=>{const s=((e,n)=>{const{skillType:a,levelPercentage:s}=t[e],o=n*s;return{id_skill:e.toString(),level:n.toString(),skill:{id_skill:e,level:n,percentage_value:o,display_value_text:`${o}%`,skill_type:a}}})(a,n);return{level:n,results:await Je(async t=>e(t,s))}}));var o;return{skillName:(o=t[a].skillType).charAt(0).toUpperCase()+o.slice(1).toLowerCase(),results:s}}))}async function Ve(e,t){const n=de();if(null==n)throw new Error("Market data not found");const a=await qe(e);if(null==a)throw new Error("Team data not found");return Ke(async(s,o)=>{const r=We(Re(e,a,n,s),o),l=1+.15*s.mythic;return w("FastPoints",r,t,l)})}async function Qe(e){if(!_e("/troll-pre-battle.html"))return;await s(),function(e){Ee(e);const{hero_data:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(e);const t=N();!function(e){const{hero_data:t,opponent_fighter:n}=e,a=Fe(t,n.player),s=Me();s.trolls=a,Se(s)}(e),async function(e){const{opponent_fighter:t,localStorageSetItem:n}=e,a=we(),s=t.player.team,r=()=>{n("battle_type","trolls"),n("troll_id",a),fe({battleType:"trolls",opponentId:a,team:s})};r(),await o();const l=document.getElementById("change_team");null!=l&&(l.addEventListener("click",r,!0),l.addEventListener("auxclick",r,!0))}(e),t.doSimulateTroll&&async function(e){const{hero_data:t,opponent_fighter:n}=e,{player:a,opponent:s}=l(t,n.player),r=y("Chance",a,s);await o();const i=new I;i.updateAsync(r),i.setTooltip(x(a,s)),$(".opponent .icon-area").before(i.getElement().addClass("sim-left"))}(e)}async function Xe(e){_e("/league-battle.html")&&(await s(),function(e){Ee(e);const{hero_fighter:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_fighter is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(e),function(e){const{hero_fighter:t}=e;be(t)}(e))}function Ye(e){e.sort((e,t)=>{const n=n=>((e,t)=>e==t?null:e-t)(n(t),n(e));return n(e=>e.result)??n(e=>e.boosterCounts.mythic)??n(e=>e.boosterCounts.cordyceps)??n(e=>e.boosterCounts.chlorella)??n(e=>e.boosterCounts.jujubes)??n(e=>e.boosterCounts.ginseng)??0})}function Ze(e,t){return`<div class="sim-booster-slot slot ${e}"><div class="sim-booster-icon sim-icon-${t}"></div></div>`}const et={ginseng:Ze("legendary","ginseng"),jujubes:Ze("legendary","jujubes"),chlorella:Ze("legendary","chlorella"),cordyceps:Ze("legendary","cordyceps"),headband:Ze("mythic","headband"),ame:Ze("mythic","ame")};function tt(e,t){return Ne.map(n=>et["mythic"===n?t:n].repeat(e[n])).join("")}function nt(e){return e.forEach(e=>{e.results.forEach(e=>{Ye(e.results)})}),function(){const t=[5,4,3,2,1].map(t=>{return n=t,P(C(1,e.map(e=>function(e){const t=e.skillName,a=e.results.find(e=>e.level===n)?.results;return null==a?"":function(e){return["<table>",P(T(2,`Level ${n} ${t}`)),...e.map(e=>P(C(1,[tt(e.boosterCounts,"headband"),`<span class="sim-chance" style="color: ${H(e.result)}">${M(e.result)}</span>`]))),"</table>"].join("")}(a)}(e))));var n});return $('<table class="sim-booster-table"></table>').append(t.join("")).prop("outerHTML")}()}function at(e){return e.forEach(e=>{e.results.forEach(e=>{Ye(e.results)})}),function(){const t=[5,4,3,2,1].map(t=>{return n=t,P(C(1,e.map(e=>function(e){const t=e.skillName,a=e.results.find(e=>e.level===n)?.results;return null==a?"":function(e){return["<table>",P(T(2,`Level ${n} ${t}`)),...e.map(e=>P(C(1,[tt(e.boosterCounts,"ame"),`<span class="sim-chance" style="color: ${H(e.result)}">${M(e.result)}</span>`]))),"</table>"].join("")}(a)}(e))));var n});return $('<table class="sim-booster-table"></table>').append(t.join("")).prop("outerHTML")}()}function st(e){Ye(e);const t=e.filter(e=>e.boosterCounts.mythic<=0),n=e.filter(e=>e.boosterCounts.mythic>0);return function(){const e=t.map((e,t)=>P(C(1,[tt(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${B(e.result)}">${E(e.result)}</span>`,tt(n[t].boosterCounts,"ame"),`<span class="sim-points" style="color: ${B(n[t].result)}">${E(n[t].result)}</span>`])));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}function ot(e){return e.forEach(e=>{e.results.forEach(e=>{Ye(e.results)})}),function(){const t=[5,4,3,2,1].map(t=>{return n=t,P(C(1,e.map(e=>function(e){const t=e.skillName,a=e.results.find(e=>e.level===n)?.results;return null==a?"":function(e){return["<table>",P(T(2,`Level ${n} ${t}`)),...e.map(e=>P(C(1,[tt(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${B(e.result)}">${E(e.result)}</span>`]))),"</table>"].join("")}(a)}(e))));var n});return $('<table class="sim-booster-table"></table>').append(t.join("")).prop("outerHTML")}()}class rt{element;content;constructor(e){this.element=$('<div class="sim-popup"></div>');const t=$('<div class="close-button xUncheck_mix_icn"></div>');t.on("click",()=>{this.hide()}),this.element.append(t),"string"==typeof e?this.element.append($('<h1 class="caption"></h1>').text(e)):this.element.append(e);const n=$('<div class="content"></div>');this.content=n,this.element.append(n)}show(){this.element.appendTo("#contains_all")}hide(){this.element.detach()}toggle(){0===this.element.parent().length?this.show():this.hide()}setContent(e){"string"==typeof e?this.content.html(e):this.content.empty().append(e)}}async function lt(e){if(!_e("/leagues-pre-battle.html"))return;await s(),function(e){Ee(e);const{hero_data:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(e);const t=N();!function(e){const{hero_data:t}=e;be(t.team)}(e),function(e){const{hero_data:t,opponent_fighter:n}=e,a=Fe(t,n.player),s=Me();s.leagues=a,Se(s)}(e),async function(e){const{opponent_fighter:t,localStorageSetItem:n}=e,a=we(),s=t.player.team,r=()=>{n("battle_type","leagues"),n("leagues_id",a),fe({battleType:"leagues",opponentId:a,team:s})};r(),await o();const l=document.getElementById("change_team");null!=l&&(l.addEventListener("click",r,!0),l.addEventListener("auxclick",r,!0))}(e),t.doSimulateLeague&&(async function(e){const{hero_data:t,opponent_fighter:n}=e,{player:a,opponent:s}=l(t,n.player),{calculateLeaguePointsTable:r}=N(),i=y(r?"Full":"Standard",a,s);await o();const c=new I;c.updateAsync(i),c.setTooltip(x(a,s)),$(".opponent .icon-area").before(c.getElement().addClass("sim-left"));const u=new le;u.updateAsync(i),i.then(e=>{u.setTooltip(xe(e))}),$(".opponent .icon-area").before(u.getElement().addClass("sim-right"))}(e),t.addBoosterSimulator&&async function(e){const{hero_data:t,opponent_fighter:n}=e,a=t.team,s=n.player.team;await o();const r=new rt("Booster simulator"),l=$('<div class="sim-result"><div class="sim-icon-button sim-icon-ame"></div></div>').addClass("sim-right").attr("tooltip","Booster simulator");let i=!1;l.on("click",()=>{i||(i=!0,r.setContent("Now loading..."),queueMicrotask(async()=>{try{const e=await De(a,s);r.setContent(st(e))}catch(e){const t=e instanceof Error?e.message:e;r.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}})),r.toggle()}),$(".battle_hero .icon-area").before(l)}(e),t.addSkillSimulator&&async function(e){const{hero_data:t,opponent_fighter:n}=e,a=t.team,s=n.player.team;await o();const r=new rt("Skill simulator"),l=$('<div class="sim-result"><div class="sim-icon-button sim-icon-girl-skills"></div></div>').addClass("sim-left").attr("tooltip","Skill simulator");let i=!1;l.on("click",()=>{i||(i=!0,r.setContent("Now loading..."),queueMicrotask(async()=>{try{const e=await Ve(a,s);r.setContent(ot(e))}catch(e){const t=e instanceof Error?e.message:e;r.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}})),r.toggle()}),$(".battle_hero .icon-area").before(l)}(e))}let it=null;async function ct(e){if(!_e("/pantheon-pre-battle.html"))return;await s(),function(e){Ee(e);const{hero_data:t,opponent_fighter:n}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("opponent_fighter is not found.")}(e);const t=N();!function(e){const{hero_data:t,opponent_fighter:n}=e,a=Fe(t,n.player),s=Me();s.pantheon=a,Se(s)}(e),async function(e){const{opponent_fighter:t,localStorageSetItem:n}=e,a=we(),s=t.player.team,r=()=>{n("battle_type","pantheon"),n("pantheon_id",a),fe({battleType:"pantheon",opponentId:a,team:s})};r(),await o();const l=document.getElementById("change_team");null!=l&&(l.addEventListener("click",r,!0),l.addEventListener("auxclick",r,!0))}(e),t.doSimulatePantheon&&(async function(e){const{hero_data:t,opponent_fighter:n}=e,{player:a,opponent:s}=l(t,n.player),r=y("Chance",a,s);await o();const i=new I;i.updateAsync(r),i.setTooltip(x(a,s)),$(".opponent .icon-area").before(i.getElement().addClass("sim-left"))}(e),t.addBoosterSimulator&&async function(e){const{hero_data:t,opponent_fighter:n}=e,a=t.team,s=n.player.team,r=ut(e);await o();const l=new rt("Booster simulator"),i=$('<div class="sim-result"><div class="sim-icon-button sim-icon-headband"></div></div>').addClass("sim-right").attr("tooltip","Booster simulator");let c=!1;i.on("click",()=>{c||(c=!0,l.setContent("Now loading..."),queueMicrotask(async()=>{try{const e=await async function(e,t,n){const a=de();if(null==a)throw new Error("Market data not found");const s=await qe(e);if(null==s)throw new Error("Team data not found");return Je(async o=>{const r=Re(e,s,a,o),l=1+.25*o.mythic;return w("FastChance",r,t,l,n)})}(a,s,r);l.setContent(function(e){Ye(e);const t=e.filter(e=>e.boosterCounts.mythic<=0),n=e.filter(e=>e.boosterCounts.mythic>0);return function(){const e=t.map((e,t)=>P(C(1,[tt(e.boosterCounts,"headband"),`<span class="sim-chance" style="color: ${H(e.result)}">${M(e.result)}</span>`,tt(n[t].boosterCounts,"headband"),`<span class="sim-chance" style="color: ${H(n[t].result)}">${M(n[t].result)}</span>`])));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(e))}catch(e){const t=e instanceof Error?e.message:e;l.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}})),l.toggle()}),$(".battle_hero .icon-area").before(i)}(e),t.addSkillSimulator&&async function(e){const{hero_data:t,opponent_fighter:n}=e,a=t.team,s=n.player.team,r=ut(e);await o();const l=new rt("Skill simulator"),i=$('<div class="sim-result"><div class="sim-icon-button sim-icon-girl-skills"></div></div>').addClass("sim-left").attr("tooltip","Skill simulator");let c=!1;i.on("click",()=>{c||(c=!0,l.setContent("Now loading..."),queueMicrotask(async()=>{try{const e=await async function(e,t,n){const a=de();if(null==a)throw new Error("Market data not found");const s=await qe(e);if(null==s)throw new Error("Team data not found");return Ke(async(o,r)=>{const l=We(Re(e,s,a,o),r),i=1+.25*o.mythic;return w("FastChance",l,t,i,n)})}(a,s,r);l.setContent(nt(e))}catch(e){const t=e instanceof Error?e.message:e;l.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}})),l.toggle()}),$(".battle_hero .icon-area").before(i)}(e))}function ut(e){const{hero_data:t,opponent_fighter:n}=e,a=t,s=n.player,o=r(a,s),l=c(a.team,s.team);return{damage:o.attack/l.attack,defense:o.defense/l.defense,ego:o.ego/l.ego,chance:1}}async function mt(e){if(!_e("/season-arena.html"))return;await s(),function(e){Ee(e);const{hero_data:t,caracs_per_opponent:n,opponents:a}=e;if(null==t)throw new Error("hero_data is not found.");if(null==n)throw new Error("caracs_per_opponent is not found.");if(null==a)throw new Error("opponents is not found.")}(e);let{hero_data:t,caracs_per_opponent:n,opponents:a}=e;!function(){const e=a[0].player,s=n[e.id_fighter],o=i(t.team,e.team),r=Math.round(100*s.damage/t.team.caracs.damage/o),l=Me();l.seasons=r/100,Se(l)}(),async function(e){const{opponents:t,localStorageSetItem:n,hero_data:{current_season_mojo:a}}=e,s=()=>{n("battle_type","seasons");const e=$(".selected_opponent").attr("data-opponent");if(null==e)return;const s=t.find(t=>+t.player.id_fighter===+e);if(null==s)return;const o=s.player.team,r=s.rewards.rewards.find(e=>"victory_points"===e.type)?.value;fe({battleType:"seasons",opponentId:e,team:o,mojo:+(r??0),currentMojo:a})};s(),await o();const r=document.getElementById("change_team");null!=r&&(r.addEventListener("click",s,!0),r.addEventListener("auxclick",s,!0))}(e);const l=N();if(l.doSimulateSeason){l.addBoosterSimulator&&async function(e){const{hero_data:t}=e,n=t.team;await o();const a=$('<div class="sim-result"><div class="sim-icon-button sim-icon-ame"></div></div>').addClass("sim-right").attr("tooltip","Booster simulator"),s={};a.on("click",()=>{const t=dt(e);if(null==t)return;let a=s[+t.player.id_fighter];null==a&&(a=new rt(`Booster simulator (${t.player.nickname})`),a.setContent("Now loading..."),s[+t.player.id_fighter]=a,queueMicrotask(async()=>{try{const e=await async function(e,t){const n=de();if(null==n)throw new Error("Market data not found");const a=await qe(e);if(null==a)throw new Error("Team data not found");return Je(async s=>{const o=Re(e,a,n,s),r=1+.15*s.mythic;return w("FastChance",o,t,r)})}(n,t.player.team);a.setContent(function(e){Ye(e);const t=e.filter(e=>e.boosterCounts.mythic<=0),n=e.filter(e=>e.boosterCounts.mythic>0);return function(){const e=t.map((e,t)=>P(C(1,[tt(e.boosterCounts,"ame"),`<span class="sim-chance" style="color: ${H(e.result)}">${M(e.result)}</span>`,tt(n[t].boosterCounts,"ame"),`<span class="sim-chance" style="color: ${H(n[t].result)}">${M(n[t].result)}</span>`])));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(e))}catch(e){const t=e instanceof Error?e.message:e;a.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}})),Object.values(s).filter(e=>e!=a).forEach(e=>e.hide()),a.toggle()}),$(".battle_hero .icon-area").before(a)}(e),l.addSkillSimulator&&async function(e){const{hero_data:t}=e,n=t.team;await o();const a=$('<div class="sim-result"><div class="sim-icon-button sim-icon-girl-skills"></div></div>').addClass("sim-left").attr("tooltip","Skill simulator"),s={};a.on("click",()=>{const t=dt(e);if(null==t)return;let a=s[+t.player.id_fighter];null==a&&(a=new rt(`Booster simulator (${t.player.nickname})`),a.setContent("Now loading..."),s[+t.player.id_fighter]=a,queueMicrotask(async()=>{try{const e=await async function(e,t){const n=de();if(null==n)throw new Error("Market data not found");const a=await qe(e);if(null==a)throw new Error("Team data not found");return Ke(async(s,o)=>{const r=We(Re(e,a,n,s),o),l=1+.15*s.mythic;return w("FastChance",r,t,l)})}(n,t.player.team);a.setContent(at(e))}catch(e){const t=e instanceof Error?e.message:e;a.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}})),Object.values(s).filter(e=>e!=a).forEach(e=>e.hide()),a.toggle()}),$(".battle_hero .icon-area").before(a)}(e),$(document).ajaxComplete((e,s,o)=>{const{url:r,data:l}=o;if(r?.startsWith("/ajax.php")&&"string"==typeof l&&l.includes("action=season_arena_reload")){const{battle_data:e}=s.responseJSON;({hero_fighter:t,opponents:a,caracs_per_opponent:n}=e)}});const s=document.querySelector(".opponents_arena");null!=s&&document.querySelectorAll(".season_arena_opponent_container[data-opponent]").length>0&&(c(),new MutationObserver(e=>{c()}).observe(s,{childList:!1,subtree:!0,attributes:!0,attributeFilter:["data-opponent"]}))}async function c(){a.forEach(async(e,a)=>{const s=e.player,l=s.id_fighter,i={...t,...n[l]},c=r(i,s),u=r(s,i),m=y("Chance",c,u),d=+e.rewards.rewards.find(e=>"victory_points"===e.type).value,p=t.current_season_mojo;await o();const h=new I;h.updateAsync(m),h.setTooltip(x(c,u));const f=new Le(d,p);f.updateAsync(m),$(`.opponent-${a}[data-opponent="${l}"] .icon-area`).before(h.getElement().addClass("sim-left")).before(f.getElement().addClass("sim-right"))})}}function dt(e){const{opponents:t}=e,n=$(".selected_opponent").attr("data-opponent");if(null==n)return;const a=t.find(e=>+e.player.id_fighter===+n);return null!=a?a:void 0}async function pt(e){_e("/shop.html")&&(await s(),function(e){Ee(e);const{equipped_armor:t,equipped_booster:n}=e;if(null==t)throw new Error("equipped_armor is not found.");if(null==n)throw new Error("equipped_booster is not found.")}(e),function(e){ht(e),ft(e),gt(e);const t=re(e),n=t.updates;"function"==typeof n&&(t.updates=function(...t){const a=n.apply(this,t);try{ht(e),ft(e),gt(e)}catch(e){console.error(e)}return a})}(e))}function ht(e){const{equipped_armor:t}=e,n=function(e,t){const n=e.infos.class,a=e.infos.harem_endurance,s=ne[(n+2)%3],o=ne[(n+1)%3],r=ne[(n+0)%3],l=e=>e[s],i=e=>e[o]+e[r],c=function(e){const t=e.club?.upgrades_data;return ae(null==t?{}:te.map(e=>t[e].level/200))}(e),u=function(e){const t=e.infos,n=t.level,a=t.class,s=[5,7,9,5,7];return ae([n*s[3-a],n*s[4-a],n*s[5-a]])}(e),m=function(e){return ae(e.infos)}(e),d=se(u,m),p=se(d,t),h=se(c,1),f=oe(d,h),g=oe(t,h);return[...Array(5)].map((e,n)=>{const s=ae(Array(3).fill(.06*n)),o=oe(p,oe(h,s));let r=t.endurance;r+=4*l(f),r*=h.endurance,r+=4*l(g),r*=h.endurance,r+=4*l(o),r+=a*h.endurance*(1+c.endurance*h.endurance);let u=t.chance;u+=i(f)/2,u*=h.chance,u+=i(g)/2,u*=h.chance,u+=i(o)/2;const m=oe(p,se(h,s));m.endurance=r,m.chance=u;const d=D(ne,m);return{damage:l(d),defense:.25*i(d),ego:d.endurance,chance:d.chance}})}(re(e),function(e){return Object.values(e).map(e=>ae(e.caracs)).reduce((e,t)=>se(e,t),ae({}))}(t));!function(e){const t=me();t.ginsengCaracs={data:e,version:1},ue(t)}(n)}function ft(e){const{equipped_armor:t}=e,n=re(e).infos.class,a=Object.values(t).map(e=>e.resonance_bonuses?.class).filter(e=>null!=e).filter(e=>+e.identifier===n).reduce((e,t)=>(e[t.resonance]+=t.bonus,e),{damage:0,ego:0});!function(e){const t=me();t.classBonus=e,ue(t)}(new Q(a).divide(100).add(1).result())}function gt(e){const{equipped_booster:t}=e;t.normal.forEach(t=>{null==t.lifetime&&(t.lifetime=e.server_now_ts+60*+t.item.duration)});const n=ee(Array(0).concat(t.normal,t.mythic));n.mythic={leagues:1,seasons:1,trolls:1,pantheon:1,...n.mythic},ke(n)}async function bt(e){_e("/teams.html")&&(await s(),function(e){Ee(e);const{teams_data:t}=e;if(null==t)throw new Error("teams_data is not found.")}(e),N().doSimulateTeams&&async function(e){const{teams_data:t,localStorageGetItem:n}=e,a=Ce(e);if(null==a)return;const s=ge()?.mojo,r=ge()?.currentMojo,l=n("battle_type"),i=Pe(l);if(null==i)return;const u=Object.fromEntries(Object.values(t).filter(e=>null!=e.id_team&&!e.locked).map(e=>{const t=c(e,a,i),n=c(a,e),{calculateLeaguePointsTable:s}=N(),o=y("leagues"!==l?"Chance":s?"Full":"Standard",t,n);return[e.id_team,{resultPromise:o,player:t,opponent:n}]}));await o(),p();const m=new MutationObserver(p),d=document.querySelector(".teams-grid-container");function p(){const e=$(".selected-team").data("idTeam"),t=u[e];if(null==t)return;const{resultPromise:n,player:a,opponent:o}=t,i=$(".team-right-part-container .icon-area"),c=new I;if(c.updateAsync(n),c.setTooltip(x(a,o)),i.before(c.getElement().addClass("sim-left")),"leagues"===l){const e=new le;e.updateAsync(n),n.then(t=>{e.setTooltip(xe(t))}),i.before(e.getElement().addClass("sim-right"))}if("seasons"===l&&null!=s&&null!=r){const e=new Le(s,r);e.updateAsync(n),i.before(e.getElement().addClass("sim-right"))}}null!=d&&m.observe(d,{subtree:!0,attributes:!0,attributeFilter:["class"]})}(e),function(e){const{teams_data:t,localStorageGetItem:n}=e,a=Object.values(t).find(e=>e.selected_for_battle_type.includes("leagues"));null!=a&&null!=a.id_team&&null!=a.theme&&1===+a.slot_index&&be(a);const s=document.getElementById("btn-select-team");s?.addEventListener("click",()=>{if("leagues"===n("battle_type")){const e=document.querySelector(".selected-team").dataset.teamIndex;if(1!==+e)return;const n=t[e];null!=n&&null!=n.id_team&&null!=n.theme&&be(n)}},!0)}(e))}let yt,_t=null,wt=null;class vt{element;selectElement;callbacks=[];constructor(e,t,n){const a=$('<div class="form-control"><div class="select-group"></div></div>'),s=$('<label class="head-group"></label>').attr("for",e).text(t),o=n.map(e=>{const t=$("<option></option>").attr("value",e.value).text(e.label);return e.selected&&t.prop("selected",!0),t}),r=$('<select icon="down-arrow"></select>').attr("name",e).attr("id",e).append(o);r.on("change",()=>{this.callbacks.forEach(e=>{e(String(r.val()))})}),a.find(".select-group").append(s).append(r),this.element=a,this.selectElement=r,r.selectric()}onChange(e){this.callbacks.push(e)}getValue(){return String(this.selectElement.val())}getElement(){return this.element}}class kt extends rt{fights;booster;output;playerTeam;opponents;currentScore;foughtCounts;cache=new Map;constructor(e,t,n,a){const s=$('<div class="sim-selectors form-wrapper"></div>'),o=new vt("sim-selector-fights","Fights",[{label:"All",value:"all"},{label:"Unfought",value:"unfought",selected:!0}]),r=new vt("sim-selector-booster","Booster",[{label:"All",value:"all",selected:!0},{label:"Boosted",value:"boosted"},{label:"Unboosted",value:"unboosted"},{label:"Unboosted (sim)",value:"unboosted_prediction"}]),l=new vt("sim-selector-output","Output",[{label:"All",value:"all",selected:!0},{label:"Best",value:"best"}]),i=()=>{this.update()};o.onChange(i),r.onChange(i),l.onChange(i),super(s.append(o.getElement(),r.getElement(),l.getElement())),this.fights=o,this.booster=r,this.output=l,this.playerTeam=e,this.opponents=t,this.currentScore=n,this.foughtCounts=a}update(){this.setContent("Now loading..."),queueMicrotask(async()=>{const e=this.fights.getValue(),t=this.booster.getValue(),n=this.output.getValue(),a="unfought"===e;try{let s=this.opponents;a&&(s=s.filter(e=>e.numChallenges>0)),"boosted"===t&&(s=s.filter(e=>e.isBoosted)),"unboosted"===t&&(s=s.filter(e=>!e.isBoosted));const o="unboosted_prediction"===t,r=await async function(e,t,n,a){const s=de();if(null==s)throw new Error("Market data not found");const o=await qe(e);if(null==o)throw new Error("Team data not found");const r=ze();return await Promise.all(r.flatMap(r=>{const l=Re(e,o,s,r.counts),i=1+.15*r.counts.mythic;return t.map(async e=>{const t=[e.id,r.key,a?"prediction":"original"].join("-");let s=n.get(t);if(null==s){const o={...e.team.caracs};if(a){const t=ee(e.boosters).normals.map(e=>e.multiplier).filter(e=>null!=e).reduce((e,t)=>Y(e,t),X({}));o.damage/=1+t.damage/100,o.ego/=1+t.ego/100,o.chance/=1+t.chance/100}const c={...e.team,caracs:o};s={boosterKey:r.key,boosterCounts:r.counts,opponentId:e.id,challenges:e.numChallenges,result:w("FastPoints",l,c,i)},n.set(t,s)}const o=await s.result;return{...s,result:o}})}))}(this.playerTeam,s,this.cache,o),l=(e,t,n)=>{let a=e.get(t);null==a&&(a=[],e.set(t,a)),a.push(n)};if("all"===n){const n=new Map;r.forEach(e=>{l(n,e.boosterKey,e)});const s=[...n.values()].map(e=>{const t=e[0].boosterCounts,n=a?e.reduce((e,t)=>e+t.result*t.challenges,0):3*e.reduce((e,t)=>e+t.result,0),s=a?e.reduce((e,t)=>e+t.challenges,0):3*e.length;return{boosterCounts:t,sum:n,challenges:s,average:n/s,result:n}});"unfought"!==e||"all"!==t&&"unboosted_prediction"!==t?this.setContent(function(e){Ye(e);const t=e.filter(e=>e.boosterCounts.mythic<=0),n=e.filter(e=>e.boosterCounts.mythic>0);return function(){const e=[...Array(Math.max(t.length,n.length))].map((e,a)=>P(C(1,[t[a],n[a]].flatMap(e=>{const t=B(e.average);return[tt(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${t}">${E(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${t}">${e.sum.toFixed()}</span>`]}))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(s)):this.setContent(function(e,t,n){Ye(e);const a=e.filter(e=>e.boosterCounts.mythic<=0),s=e.filter(e=>e.boosterCounts.mythic>0);return function(){const e=[...Array(Math.max(a.length,s.length))].map((e,o)=>P(C(1,[a[o],s[o]].flatMap(e=>{const a=B(e.average),s=e.sum+t,o=s/(e.challenges+n),r=B(o);return[tt(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${a}">${E(e.average)}</span>`,"*",`<span>${e.challenges.toFixed()}</span>`,"=",`<span style="color: ${a}">${e.sum.toFixed()}</span>`,"=>",`<span style="color: ${r}">${s.toFixed()}</span>`,`<span style="color: ${r}">(${E(o)})</span>`]}))));return $('<table class="sim-booster-table"></table>').append(e.join("")).prop("outerHTML")}()}(s,this.currentScore,this.foughtCounts))}if("best"===n){const n=new Map;r.forEach(e=>{l(n,e.opponentId,e)});const[s,o]=[[...n.values()].map(e=>e.filter(e=>0==e.boosterCounts.mythic)),[...n.values()]].map(e=>{const t=new Map;e.forEach(e=>{const n=e.reduce((e,t)=>Math.max(e,t.result),0);e.filter(e=>e.result>=n).forEach(e=>{l(t,e.boosterKey,e)})});const n=new Set,s=[];let o=[...t.values()];for(;0!==o.length;){const e=o.sort((e,t)=>e.length-t.length).pop();if(0===e.length)break;s.push(e),e.forEach(e=>{n.add(e.opponentId)}),o=o.map(e=>e.filter(e=>!n.has(e.opponentId)))}return s.map(e=>{const t=e[0].boosterCounts,n=a?e.reduce((e,t)=>e+t.result*t.challenges,0):3*e.reduce((e,t)=>e+t.result,0),s=a?e.reduce((e,t)=>e+t.challenges,0):3*e.length;return{boosterCounts:t,sum:n,challenges:s,average:n/s,result:s}})});"unfought"!==e||"all"!==t&&"unboosted_prediction"!==t?this.setContent(function(e,t){Ye(e),Ye(t);const n=[e,t].map(e=>{const t=e.reduce((e,t)=>e+t.sum,0),n=e.reduce((e,t)=>e+t.challenges,0),a=t/n;return{sum:t,challenges:n,average:a,color:B(a)}});return function(){const a=[...Array(Math.max(e.length,t.length))].map((n,a)=>P(C(1,[e[a],t[a]].flatMap(e=>{if(null==e)return Array(6).fill("");const t=B(e.average);return[tt(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${t}">${E(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${t}">${e.sum.toFixed()}</span>`]}))));return $('<table class="sim-booster-table"></table>').append(P(C(6,["No AME","All"])),a.join(""),P(C(1,n.flatMap(e=>["Sum:",`<span class="sim-points" style="color: ${e.color}">${E(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${e.color}">${e.sum.toFixed()}</span>`])))).prop("outerHTML")}()}(s,o)):this.setContent(function(e,t,n,a){Ye(e),Ye(t);const s=0===a?NaN:n/a,o=0===a?"#FFF":B(s),r=[e,t].map(e=>{const t=e.reduce((e,t)=>e+t.sum,0),s=e.reduce((e,t)=>e+t.challenges,0),o=t/s,r=B(o),l=t+n,i=l/(s+a);return{sum:t,challenges:s,average:o,color:r,total:l,avgTotal:i,color3:B(i)}});return function(){const l=[...Array(Math.max(e.length,t.length))].map((n,a)=>P(C(1,[e[a],t[a]].flatMap(e=>{if(null==e)return Array(6).fill("");const t=B(e.average);return[tt(e.boosterCounts,"ame"),`<span class="sim-points" style="color: ${t}">${E(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${t}">${e.sum.toFixed()}</span>`]}))));return $('<table class="sim-booster-table"></table>').append(P(C(6,["No AME","All"])),l.join(""),P(C(1,r.flatMap(e=>["Sum",`<span class="sim-points" style="color: ${e.color}">${E(e.average)}</span>`,"*",`<span class="sim-points">${e.challenges.toFixed()}</span>`,"=",`<span class="sim-points" style="color: ${e.color}">${e.sum.toFixed()}</span>`]))),P(C(1,r.flatMap(e=>["Current score",`<span style="color: ${o}">${Number.isNaN(s)?"?":E(s)}</span>`,"*",`<span>${a}</span>`,"=",`<span style="color: ${o}">${n}</span>`]))),P(C(1,r.flatMap(e=>["Total",`<span style="color: ${e.color3}">${E(e.avgTotal)}</span>`,"*",`<span>${e.challenges+a}</span>`,"=",`<span style="color: ${e.color3}">${e.total.toFixed()}</span>`])))).prop("outerHTML")}()}(s,o,this.currentScore,this.foughtCounts))}}catch(e){const t=e instanceof Error?e.message:e;this.setContent(`Error: ${t}<br>1. Go to the market page<br>2. Try again`)}})}show(){this.update(),super.show()}}function $t(e){Ee(e);const{opponents_list:t}=e;if(null==t)throw new Error("opponents_list is not found.")}async function St(e){if(!_e("/leagues.html"))return;await s(),$t(e);const{opponents_list:t}=e,n=re(e);!function(e){const{opponents_list:t,server_now_ts:n}=e,a=re(e).infos.id,s=t.find(e=>+e.player.id_fighter===a);if(null==s)return;const o=s.boosters.filter(e=>+e.lifetime>n||+e.usages_remaining>0),r=$e(),l=ee(o);l.mythic={...r.mythic,...l.mythic},ke(l)}(e),async function(e){const a=N();if(!a.doSimulateLeagueTable)return;const s=n.infos.id,r=t.find(e=>+e.player.id_fighter===s);if(null==r)return;const l=await Ct(e),i=l.leagueMultiplier,c=l.team;if(null==i||null==c)return;const u=t.filter(e=>+e.player.id_fighter!==s),m=u.filter(e=>Object.values(e.match_history)[0].filter(e=>null!=e).length<3),d=a.addChanceToLeagueTable?"Standard":"Points",p=(a.doSimulateFoughtOpponents?u:m).map(e=>w(d,c,e.player.team,i).then(t=>[e.player.id_fighter,t])),h=await Promise.all(p),f=Object.fromEntries(h),g=()=>{t.forEach(e=>{e.power=f[e.player.id_fighter]?.avgPoints??0}),a.replaceHHLeaguesPlusPlus&&t.forEach(e=>{e.sim={...e.sim,forSim:{...e.sim?.forSim,playerTeam:c,opponentTeam:e.player.team,mythicBoosterMultiplier:i}}})};g();const b=t.reduce((e,t)=>{const n=Object.values(t.match_history)[0];if(!Array.isArray(n))return e;const a=n.filter(e=>null!=e),s=a.reduce((e,t)=>e+parseInt(t.match_points),0),o=3-a.length;return e+s+t.power*o},0),y=b/(t.length-1)/3,_=3*h.reduce((e,t)=>e+t[1].avgPoints,0),k=_/h.length/3;await o(),$('.league_table .head-column[column="match_history_sorting"] > span').attr("tooltip",`Score expected: <em>${v(b,1)}</em><br>Average: <em>${E(y)}</em>`);const M=$('.league_table .head-column[column="power"] > span');M.html(M.html().replace("Power","Sim")),M.attr("tooltip",`Sum: <em>${v(_,1)}</em><br>Average: <em>${E(k)}</em>`);const T=u.map(t=>({id:t.player.id_fighter,team:t.player.team,numChallenges:3-Object.values(t.match_history)[0].filter(e=>null!=e).length,isBoosted:t.boosters.filter(t=>+t.lifetime>e.server_now_ts).length>0,boosters:t.boosters})),C=+r.player_league_points,P=T.reduce((e,t)=>e+(3-t.numChallenges),0),x=new kt(c,T,C,P),L=()=>{const e={};document.querySelectorAll(".data-row.body-row").forEach(t=>{const n=t.querySelector("[id-member]")?.getAttribute("id-member"),a=t.querySelector(".data-column[column=power]");null!=n&&null!=a&&(e[n]??=[],e[n].push(a))}),t.forEach(t=>{const n=$("<div></div>").addClass("sim-column"),o=t.player.id_fighter,r=f[o];if(null!=r)if(a.addChanceToLeagueTable){let e="",t="";a.addGuaranteedMarkToLeagueTable&&(r.minPoints>=25&&(e='<div class="vCheck_mix_icn sim-mark"></div>'),r.alwaysWin&&(t='<div class="vCheck_mix_icn sim-mark"></div>'),r.neverWin&&(t='<div class="xUncheck_mix_icn sim-mark"></div>')),n.addClass("sim-column-small").append($(`<div>${e}${v(r.avgPoints,2)}</div>`).css("color",B(r.avgPoints))).append($(`<div>${t}${S(r.chance)}</div>`).css("color",H(r.chance)))}else{let e="";a.addGuaranteedMarkToLeagueTable&&r.minPoints>=25&&(e='<div class="vCheck_mix_icn sim-mark"></div>'),n.html(`${e}${v(r.avgPoints,2)}`).css("color",B(r.avgPoints))}else if(+o===s&&a.addBoosterSimulator&&a.addBoosterSimulatorToLeagueTable){const e=$('<div class="sim-icon-button sim-icon-ame"></div>').attr("tooltip","Booster simulator");e.on("click",()=>{x.toggle()}),n.append(e)}else n.text("-");$(e[o]).empty().append(n)})};function j(){F().then(t=>{if(null==t)return;const n=e.opponent_fighter;null!=n?.sim&&(new t.League).display(n.sim)})}L(),a.replaceHHLeaguesPlusPlus&&j();const A=M[0];null!=A&&new MutationObserver(()=>{g(),L(),a.replaceHHLeaguesPlusPlus&&j()}).observe(A,{childList:!0,subtree:!0});const I=document.querySelector(".league_table .data-list");null!=I&&new MutationObserver(()=>{g(),L()}).observe(I,{childList:!0})}(e),async function(){await o();const e=document.getElementById("change_team");if(null!=e){const t=()=>{N().replaceHHLeaguesPlusPlus&&null!=yt?fe({battleType:"leagues",opponentId:"",team:yt}):fe(null)};e.addEventListener("click",t,!0),e.addEventListener("auxclick",t,!0)}}()}let Mt=null;async function Et(e){return Mt??=(async()=>{try{const{opponents_list:t}=e,n=t.filter(e=>{const t=Object.values(e.match_history)[0];return Array.isArray(t)&&t.some(e=>null===e)})[0]?.player.id_fighter;if(null!=n){const{hero_data:e,opponent_fighter:t}=await async function(e){return it??=(async()=>{const t=ve(`leagues-pre-battle.html?id_opponent=${e}`),n=await fetch(t),a=await n.text();return{hero_data:JSON.parse(a.match(/var\s+hero_data\s*=\s*(\{.*?\});/s)[1]),opponent_fighter:Function("return "+a.match(/var\s+opponent_fighter\s*=\s*(\{.*?\});/s)[1])()}})(),it}(n),a=e.team;if(null!=a)return be(a),{player:e,opponent:t.player}}}catch(e){console.error(e)}return null})(),Mt}let Tt=null;async function Ct(e){return Tt??=(async()=>{let t,n;const{referrer:a}=document;if(["leagues-pre-battle.html","league-battle.html"].some(e=>a.includes(e))&&(t=ye(),n=Me().leagues??null,null!=t&&null!=n))return{team:t,leagueMultiplier:n};try{const n=await Et(e);if(null!=n){const{player:e,opponent:t}=n,{team:a}=e;be(a);const s=Fe(e,t);return Se({...Me(),leagues:s}),{team:a,leagueMultiplier:s}}{const e=await async function(){return wt??=(async()=>{const{referrer:e}=document;if(["leagues-pre-battle.html","league-battle.html"].some(t=>e.includes(t))){const e=ye();if(null!=e)return e}try{const e=(await async function(){return _t??=(async()=>{const e=ve("teams.html?battle_type=pantheon"),t=await fetch(e),n=await t.text();return{teams_data:JSON.parse(n.match(/var\s+teams_data\s*=\s*(\{.*?\});/)[1])}})(),_t}()).teams_data,t=Object.values(e).find(e=>e.selected_for_battle_type?.includes("leagues"));if(null!=t)return be(t),t}catch(e){console.error(e)}return ye()})(),wt}(),n=e?.id_team;null!=n&&(t=await async function(e){return Oe??=(async()=>{const{referrer:t}=document;if(["leagues-pre-battle.html","league-battle.html"].some(e=>t.includes(e))){const e=ye();if(null!=e)return e}try{const t=(await Be(e,"leagues")).hero_data.team;if(null!=t)return be(t),t}catch(e){console.error(e)}return ye()})(),Oe}(+n)??t,null!=t&&be(t))}}catch(e){console.error(e)}return void 0===t&&(t=ye()),void 0===n&&(n=Me().leagues??null),{team:t,leagueMultiplier:n}})(),Tt}!async function(e){await s();const{IMAGES_URL:t,SITE_ROOT:n}=window;"string"==typeof t&&(e=e.replaceAll("${IMAGES_URL}",t)),"string"==typeof n&&(e=e.replaceAll("${SITE_ROOT}",n)),$(document.head).append(`<style>${e}</style>`)}(".sim-result{width:max-content;height:0;position:relative;bottom:1.25rem;line-height:1.25rem;text-align:center;text-shadow:-1px -1px 0 #000,-1px 1px 0 #000,1px -1px 0 #000,1px 1px 0 #000;z-index:1}.sim-result .sim-label{font-size:.75rem}.sim-result.sim-left{margin-right:60%}.sim-result.sim-right{margin-left:60%}.opponent .sim-result.sim-top{bottom:12rem}#season-arena .opponent .sim-result.sim-top{bottom:11.5rem;line-height:1rem}.sim-result.sim-pending{color:#999}div.sim-mark{display:inline-block;width:1em;height:1em;margin:-.125em .25em .125em -1.25em;background-size:1em;vertical-align:bottom}table.sim-table{border-collapse:collapse;color:#fff;background-color:#000;font-size:.75rem;line-height:1rem}table.sim-table td{padding:.25rem;border:1px solid #999}table.sim-points-table{border-collapse:collapse;color:#fff;background-color:#000;font-size:.75rem;line-height:1.25rem;text-shadow:-1px -1px 0 #000,-1px 1px 0 #000,1px -1px 0 #000,1px 1px 0 #000}table.sim-points-table td{padding:1px .25rem}.sim-points-table .sim-bar-container{width:5rem}.sim-points-table .sim-bar{height:1.25rem;margin-bottom:-1.25rem;background-color:#ccf9}.sim-column{text-align:center;text-wrap:nowrap}.sim-column-small{font-size:.75rem;line-height:1.25}.sim-column .sim-mark{margin:.25em 0}.sim-column-small .sim-mark{margin:0 0 .2em 0}#pre-battle .player_team_block{min-width:15rem}.sim-popup{position:absolute;left:0;right:0;top:5rem;z-index:36;margin:auto;width:min-content;height:min-content;color:#fff;background-color:#000;border:.75rem solid #000;border-radius:.5rem;text-align:left}.sim-popup .close-button{position:absolute;right:-.25rem;top:-.25rem;cursor:pointer}.sim-popup .caption{font-size:1rem;line-height:1.5rem;width:max-content;margin:0 3rem .75rem 0}.sim-popup .content{font-size:.75rem;line-height:1.5rem;width:max-content;max-height:27rem;overflow-y:auto}table.sim-booster-table{border-collapse:separate;font-size:.75rem;line-height:1.5rem;width:max-content}table.sim-booster-table td span.sim-chance{margin:0 .5rem}table.sim-booster-table .sim-booster-slot{width:1.5rem;height:1.5rem;border:1px solid #fff}table.sim-booster-table .sim-booster-icon{width:100%;height:100%;background-size:contain}.sim-icon-button{display:block;width:2.5rem;height:2.5rem;background-size:contain;cursor:pointer}.sim-icon-ginseng{background-image:url('${IMAGES_URL}/pictures/items/B1.png')}.sim-icon-jujubes{background-image:url('${IMAGES_URL}/pictures/items/B2.png')}.sim-icon-chlorella{background-image:url('${IMAGES_URL}/pictures/items/B3.png')}.sim-icon-cordyceps{background-image:url('${IMAGES_URL}/pictures/items/B4.png')}.sim-icon-ame{background-image:url('${IMAGES_URL}/pictures/items/MB2.png')}.sim-icon-headband{background-image:url('${IMAGES_URL}/pictures/items/MB3.png')}.sim-icon-girl-skills{background-image:url('${IMAGES_URL}/pictures/design/girl_skills/active_skills_icon.png')}.sim-column .sim-icon-button{margin:-1rem auto}.sim-selectors.form-wrapper{display:flex;margin:-.5rem 3rem 0 0;gap:.5rem;width:min-content}.sim-selectors.form-wrapper>.form-control{width:9rem}.sim-selectors.form-wrapper>.form-control>.select-group .selectric-items{height:auto}.sim-selectors.form-wrapper>.form-control>.select-group .selectric-items li:first-of-type{padding-left:5px}.sim-traits{margin:.5rem .5rem 0 .5rem}.sim-trait-icon{display:inline-block;width:1.75rem;height:1.75rem;background-size:contain;background-position:center}html .new_girl_tooltip.pvp-v4 .stats-wrapper{padding-bottom:.25rem}html .new_girl_tooltip.pvp-v4 .stats-wrapper .caracs{margin-top:0;margin-bottom:0;height:auto}html .new_girl_tooltip.pvp-v4 .stats-wrapper .right-section{margin-top:-2rem;margin-left:7rem}html .new_girl_tooltip.pvp-v4 .stats-wrapper .right-section .skill-wrapper .skill-preview{left:-2.5rem}.new_girl_tooltip.pvp-v4 .sim-traits{margin-top:.25rem}.new_girl_tooltip.pvp-v4 .sim-with-relics{color:#f0f!important}"),async function(){(async function(){const e=await G;null!=e&&(e.registerGroup({key:"sim-v4",name:"Sim v4"}),q.addBattleSimulator=!1,q.doSimulateTroll=!1,q.doSimulateLeague=!1,q.doSimulateSeason=!1,q.doSimulatePantheon=!1,q.doSimulateTeams=!1,q.doSimulateEditTeam=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"BattleSimulator",label:"Battle Sim",default:!0,subSettings:[{key:"troll",default:!0,label:"Villain"},{key:"league",default:!0,label:"League"},{key:"season",default:!0,label:"Season"},{key:"pantheon",default:!0,label:"Pantheon"},{key:"teams",default:!0,label:"Team Selecting"},{key:"editTeam",default:!0,label:"Team Editing"}]},run(e){q.addBattleSimulator=!0,q.doSimulateTroll=e.troll,q.doSimulateLeague=e.league,q.doSimulateSeason=e.season,q.doSimulatePantheon=e.pantheon,q.doSimulateTeams=e.teams,q.doSimulateEditTeam=e.editTeam}}),q.doSimulateLeagueTable=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"DoSimulateLeagueTable",label:"Run simulations in the league table (maybe slow)",default:!0,subSettings:[{key:"skip",default:!0,label:"Skip fought opponents"},{key:"booster",default:!1,label:"Add booster simulator"},{key:"chance",default:!1,label:"Add chance"},{key:"mark",default:!0,label:"Add guaranteed mark"}]},run(e){q.doSimulateLeagueTable=!0,q.doSimulateFoughtOpponents=!e.skip,q.addBoosterSimulatorToLeagueTable=e.booster,q.addChanceToLeagueTable=e.chance,q.addGuaranteedMarkToLeagueTable=e.mark}}),q.calculateLeaguePointsTable=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"CalculateLeaguePointsTable",label:"Calculate each probability of league score (maybe slow)",default:!1},run(){q.calculateLeaguePointsTable=!0}}),q.addBoosterSimulator=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"BoosterSimulator",label:"Booster Sim",default:!0,subSettings:[{key:"ginseng",default:!0,label:"Ginseng"},{key:"jujubes",default:!1,label:"Jujubes"},{key:"chlorella",default:!0,label:"Chlorella"},{key:"cordyceps",default:!0,label:"Cordyceps"}]},run(e){q.addBoosterSimulator=!0,q.simulateGinseng=e.ginseng,q.simulateJujubes=e.jujubes,q.simulateChlorella=e.chlorella,q.simulateCordyceps=e.cordyceps}}),q.addSkillSimulator=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"SkillSimulator",label:"Skill Sim",default:!1,subSettings:[{key:"level5",default:!0,label:"Level 5"},{key:"level4",default:!0,label:"Level 4"},{key:"level3",default:!1,label:"Level 3"},{key:"level2",default:!1,label:"Level 2"},{key:"level1",default:!1,label:"Level 1"}]},run(e){q.addSkillSimulator=!0,q.skillLevelsToBeSimulated=[5,4,3,2,1].filter(t=>e["level"+t])}}),q.replaceHHLeaguesPlusPlus=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"ReplaceHHLeaguesPlusPlus",label:"Replace HH Leagues++ sim",default:!0},run(){q.replaceHHLeaguesPlusPlus=!0}}),q.addGirlTraitsToGirlTooltip=!1,e.registerModule({group:"sim-v4",configSchema:{baseKey:"AddGirlTraitsToGirlTooltip",label:"Add girl's traits to girl's tooltip",default:!0},run(){q.addGirlTraitsToGirlTooltip=!0}}),e.loadConfig(),e.runModules())})(),async function(){if(!_e("/leagues.html"))return;await s();const e=await F();if(null==e)return;const t=N();if(!t.replaceHHLeaguesPlusPlus)return;$t(window);const n=window;let a,o,r,l=t.doSimulateLeagueTable;const i=e.League;e.League=class{original;constructor(...e){this.original=new i(...e)}extract(){return this.original.extract()}display(e){r=e;let{forSim:s}=e;if(null==s){l||(l=!0,(async()=>{const e=await Ct(n);a=e?.team,o=e?.leagueMultiplier??1;const t=r?.forSim;null!=t&&!0===t.hasAssumptions&&(t.playerTeam=a,t.mythicBoosterMultiplier=o,this.display(r))})());const t=window.hero_data,i=window.opponent_fighter;if(null!=t&&null!=i){const r=a??t.team,l=$(".data-row.body-row.selected [id-member]").attr("id-member"),c=((null!=l?n.opponents_list.find(e=>+e.player.id_fighter===+l):null)??i).player.team,u=o??1,m=null==r.id_team;s={playerTeam:r,opponentTeam:c,mythicBoosterMultiplier:u,hasAssumptions:m},e.forSim=s}}if(null!=s){let e=s.playerTeam;const n=s.opponentTeam;if(yt=n,null==s.result||s.hasAssumptions&&null!=e.id_team){e=a??e;const t=o??s.mythicBoosterMultiplier??1,{player:r,opponent:l}=function(e,t,n=1){return{player:c(e,t,n),opponent:c(t,e)}}(e,n,t);s.battleTable=x(r,l);const i=null==e.id_team;s.hasAssumptions=i;const{calculateLeaguePointsTable:u}=N(),m=u?"Full":"Standard";s.result=y(m,r,l).then(e=>({...e,hasAssumptions:i}))}const r=s.result;$(".opponent .icon-area").parent().find(".sim-result").remove();const l=new I;l.updateAsync(r),l.setTooltip(s.battleTable),$(".opponent .icon-area").before(l.getElement().addClass("sim-left"));const i=new le;if(i.updateAsync(r),r.then(e=>{i.setTooltip(xe(e))}),$(".opponent .icon-area").before(i.getElement().addClass("sim-right")),null!=e.id_team){if(t.addBoosterSimulator){const t=new rt("Booster simulator"),a=$('<div class="sim-result"><div class="sim-icon-button sim-icon-ame"></div></div>').addClass("sim-left").addClass("sim-top").attr("tooltip","Booster simulator");a.on("click",async()=>{if(t.toggle(),null==s.boosterTable){t.setContent("Now loading..."),null==s.boosterResults&&(s.boosterResults=De(e,n));try{const e=await s.boosterResults;s.boosterTable=st(e)}catch(e){const t=e instanceof Error?e.message:e;s.boosterTable=`Error: ${t}<br>1. Go to the market page<br>2. Try again`}}t.setContent(s.boosterTable)}),$(".opponent .icon-area").before(a)}if(t.addSkillSimulator){const t=new rt("Skill simulator"),a=$('<div class="sim-result"><div class="sim-icon-button sim-icon-girl-skills"></div></div>').addClass("sim-right").addClass("sim-top").attr("tooltip","Skill simulator");a.on("click",async()=>{if(t.toggle(),null==s.skillTable){t.setContent("Now loading..."),null==s.skillResults&&(s.skillResults=Ve(e,n));try{const e=await s.skillResults;s.skillTable=ot(e)}catch(e){const t=e instanceof Error?e.message:e;s.skillTable=`Error: ${t}<br>1. Go to the market page<br>2. Try again`}}t.setContent(s.skillTable)}),$(".opponent .icon-area").before(a)}}return}return this.original.display(e)}}}(),[Te,je,Xe,lt,ct,mt,pt,bt,St,Qe].forEach(e=>{queueMicrotask(()=>{e(window)})}),async function(){await o();const e=()=>{$(".matchRating").length>0&&$(".sim-result").addClass("sim-top")};e();const t=new MutationObserver(e);document.querySelectorAll(".player_team_block.opponent, .season_arena_opponent_container").forEach(e=>{t.observe(e,{childList:!0,subtree:!0})})}(),localStorage.removeItem("HHBattleSimulatorLastOpponentId"),localStorage.removeItem("HHBattleSimulatorLastOpponentTeam"),localStorage.removeItem("HHBattleSimulatorPlayerLeaguesTeam"),localStorage.removeItem("HHBattleSimulatorPlayerBoosterBonus")}()})();